<script>
var STARTUP_DELAY = 5000;
var TASK_INTERVAL = 1000;
var TASK_INTERVAL_SHORT = 0;
var g_active=false;
var g_tabId = -1;
var g_start = 0;
var g_requesting_task = false;

// on startup, kick off our testing
setTimeout( "wptStartup()", STARTUP_DELAY );

function wptStartup() {
	chrome.tabs.getSelected(null, function(tab){
		g_tabId = tab.id;
		setInterval( "wptGetTask()", TASK_INTERVAL );
	});
}

// navigate to the provided url
function wptNavigate(url){
  chrome.tabs.update(g_tabId, {"url":url}, function(tab) {
  });
}

// execute a single task/script command
function wptExecuteTask(task){
  if (task.action.length) {
    if (task.record)
	  g_active = true;
    else
	  g_active = false;

    // decode and execute the actual command
    if (task.action == "navigate")
	  wptNavigate(task.target);

    if (!g_active)
	  setTimeout( "wptGetTask()", TASK_INTERVAL_SHORT );
  }
}

// get the next task from the wptdriver
function wptGetTask(){
  if (!g_requesting_task) {
    g_requesting_task = true;
    try{
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "http://127.0.0.1:8888/task", true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          var resp = JSON.parse(xhr.responseText);
          if (resp.statusCode == 200)
            wptExecuteTask(resp.data);
        }
      }
      xhr.send();
    }catch(err){}
    g_requesting_task = false;
  }
}

// notification that navigation started
function wptOnNavigate(){
  try{
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://127.0.0.1:8888/event/navigate", true);
    xhr.send();
  }catch(err){}
}

// notification that the page loaded
function wptOnLoad(load_time){
  try{
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://127.0.0.1:8888/event/load?load_time="+load_time, true);
    xhr.send();
  }catch(err){}
}

// install an onLoad handler for all tabs
chrome.tabs.onUpdated.addListener(function(tabId, props) {
  if (g_active){
    if (props.status == "loading")
      wptOnNavigate();
    if (props.status == "complete") {
	  // get the navigation timings from the page
	  chrome.tabs.executeScript(tabId, {file: "script.js"});
	}
  }
});

// Add a listener for messages from script.js.
chrome.extension.onConnect.addListener(function(port) {
  port.onMessage.addListener(function(data) {
    if (data.message == "load") {
      wptOnLoad(data.load_time);
    }    
  });
});

</script>
