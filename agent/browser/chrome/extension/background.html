<script>
var g_active=false;
var g_tabId = -1;
var g_start = 0;

// navigate to the provided url
function wptNavigate(url){
  chrome.tabs.update(g_tabId, {"url":url}, function(tab) {
    chrome.tabs.executeScript(tab.id, {file: "script.js"});
  });
}

// execute a single task/script command
function wptExecuteTask(task){
  g_active = true;
  if (task.action == "navigate")
	wptNavigate(task.target);
}

// get the next task from the wptdriver
function wptGetTask(){
  try{
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "http://127.0.0.1:8888/task", true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
	    var resp = JSON.parse(xhr.responseText);
	    if (resp.statusCode == 200)
          wptExecuteTask(resp.data);
      }
    }
    xhr.send();
  }catch(err){}
}

// notification that navigation started
function wptOnNavigate(){
  try{
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://127.0.0.1:8888/event/navigate", true);
    xhr.send();
  }catch(err){}
}

// notification that the page loaded
function wptOnLoad(){
  try{
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://127.0.0.1:8888/event/load", true);
    xhr.send();
  }catch(err){}
}

// if we start up on about:blank, try connecting to the wptdriver for work
chrome.tabs.getSelected(null, function(tab){
  if( tab.url == "about:blank" ){
    g_tabId = tab.id;
    setTimeout( "wptGetTask()", 1000 );
  }
});

// install an onLoad handler for all tabs
chrome.tabs.onUpdated.addListener(function(tabId, props) {
  if (g_active){
    if (props.status == "loading")
	  wptOnNavigate();
    if (props.status == "complete")
	  wptOnLoad();
  } else {
    if (props.status == "complete" && props.url == "about:blank") {
	  g_tabId = tabId;
	  setTimeout( "wptGetTask()", 1000 );
	}
  }
});

// Add a listener for messages from script.js.
chrome.extension.onConnect.addListener(function(port) {
  port.onMessage.addListener(function(data) {
  });
});

</script>
